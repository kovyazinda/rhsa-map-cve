<?php
$reportname = "rhsa-cve-map.csv";

$strings = array();
$columns = array();
$cve = array();

// Creating Stream
$opts = array(
  'http'=>array(
    'method'=>"GET",
    'header'=>"Accept-language: en\r\n"
  )
);

$context = stream_context_create($opts);

// Opening stream
$file = file_get_contents('https://www.redhat.com/security/data/metrics/rhsamapcpe.txt', false, $context);

file_put_contents($reportname,"CVE;RHSA;v5;v6;v7;v8\n");

// Splitting by strings
$strings = explode("\n",$file);

$i = 0;

foreach ($strings as $string)
    {
// Splitting by columns
    $columns[$i] = explode(" ",$strings[$i]);

	$cve[$i] = explode(",",$columns[$i][1]);

$v5=0;
$v6=0;
$v7=0;
$v8=0;

// checking applicability by version
for ($k = 1; $k <= 10; $k++)
{ 
	if (preg_match("/:5::/",$columns[$i][2]) )
		{
		$v5=1;
		}
	if (preg_match("/:5\n/",$columns[$i][2]) )
		{
		$v5=1;
		}
	if (preg_match("/:5.$k:/",$columns[$i][2]) )
		{
		$v5=1;
		}


	if (preg_match("/:6::/",$columns[$i][2]) )
		{
		$v6=1;
		}
	if (preg_match("/:6\n/",$columns[$i][2]) )
		{
		$v6=1;
		}
	if (preg_match("/:6.$k:/",$columns[$i][2]) )
		{
		$v6=1;
		}

	if (preg_match("/:7::/",$columns[$i][2]) )
		{
		$v7=1;
		}
	if (preg_match("/:7\n/",$columns[$i][2]) )
		{
		$v7=1;
		}
	if (preg_match("/:7.$k:/",$columns[$i][2]) )
		{
		$v7=1;
		}

	if (preg_match("/:8::/",$columns[$i][2]) )
		{
		$v8=1;
		}
	if (preg_match("/:8\n/",$columns[$i][2]) )
		{
		$v8=1;
		}
	if (preg_match("/:8.$k:/",$columns[$i][2]) )
		{
		$v8=1;
		}


}
// getting CVE
	foreach ($cve[$i] as $current_cve)
		{
		

		file_put_contents($reportname,$current_cve.";".$columns[$i][0].";".$v5.";".$v6.";".$v7.";".$v8."\n", FILE_APPEND);

		print "\n";
		}



    $i++;

    }

?>
